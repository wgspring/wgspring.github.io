---
title: 文件系统-文件和目录在硬盘上的存储方式
date: 2020-05-03T13:39:10+08:00
coverImage: https://s1.ax1x.com/2020/05/03/Jz2TdU.jpg
categories: 
    - Linux
tags: 
    - Linux
---
曾经我以为路径不同的两个文件一定就不是同一个文件；曾经我一直不能理解硬链接是什么意思，为什么链接数为0才算真正删除了这个文件？如果你也有这个疑问，一起看下去吧。

<!-- more -->
文件系统指文件存在的**物理空间**，linux系统中每个分区都是一个文件系统，都有自己的目录层次结构。linux会将这些分属不同分区的、单独的文件系统按一定的方式形成一个系统的总的目录层次结构。一个操作系统的运行离不开对文件的操作，因此必然要拥有并维护自己的文件系统。linux文件系统使用索引节点来记录文件信息，作用像windows的文件分配表。

索引节点(i节点)是一个结构，它包含了一个文件的长度、创建及修改时间、权限、所属关系、磁盘中的位置等信息。一个文件系统维护了一个索引节点的数组，**每个文件或目录都与索引节点数组中的唯一一个元素对应**。系统给每个索引节点分配了一个号码，也就是该节点在数组中的索引号，称为索引节点号。

linux文件系统将文件索引节点号和文件名同时保存在目录中。所以，目录只是将文件的名称和它的索引节点号结合在一起的一张表，目录中每一对文件名称和索引节点号称为一个连接。

**对于一个文件来说有唯一的索引节点号与之对应，对于一个索引节点号，却可以有多个文件名与之对应。**因此，在磁盘上的同一个文件可以通过不同的路径去访问它。


首先我们应该知道一个磁盘可以划分为多个分区，而每个分区就可以包含一个文件系统。

![](/img/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F-%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95%E5%9C%A8%E7%A1%AC%E7%9B%98%E4%B8%8A%E7%9A%84%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.png)

而我们主要关心的是i节点和数据块。i节点是固定长度的记录项，它包含有关文件的大部分信息。一个柱面组的i节点和数据块的部分是以下这样的：

![](/img/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F-%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95%E5%9C%A8%E7%A1%AC%E7%9B%98%E4%B8%8A%E7%9A%84%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F/%E6%96%87%E4%BB%B6%E8%8A%82%E7%82%B9.png)

注意：一个文件可能有多个数据块组成，但是一个i节点就只对应一个文件。

从这图我们就可以知道，i节点是存放文件的信息（比如stat结构里描述的那些属性），数据块就是存放文件的内容的。那么目录块是什么呢？从图可知，目录块包含了i节点号和文件名。其实这就是hard link（硬链接）。在图中由两个目录项指向同一i节点。每个i节点都有一个链接计数(link count)，保存的是指向该i节点的目录项数。**只有当链接计数减少至0时，才可以删除该文件**（也就是释放该文件占用的数据块）。这就是为什么“解除一个文件的链接”操作并不总是意味着“释放该文件占用的磁盘块”的原因（因为一个文件可以由多个目录项，也就是多个硬链接）。这也就是为什么删除一个目录项的函数被称为unlink而不是delete的原因。

另外一种链接类型被成为符号链接/软链接(symbolic link)。对于这种链接，该文件的实际内容（在数据块中）包含了除该符号链接所指向的文件的名字（简单来说，就相当于windows下的快捷方式）。

i节点包括了大多数与文件有关的信息：文件类型、文件访问权限位、文件长度和指向该文件所占用的数据块的指针等等。只有两项数据存放在目录项中：文件名和i节点号。

当在不更换文件系统情况下为一个文件更名时，该文件的实际内容并未移动，只需构造一个指向现有i节点的新目录项，并解除与旧目录项的链接。这就是mv命令的通常操作方式。

接下来讲下目录的i节点：

![](/img/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F-%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95%E5%9C%A8%E7%A1%AC%E7%9B%98%E4%B8%8A%E7%9A%84%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F/%E7%9B%AE%E5%BD%95%E8%8A%82%E7%82%B9.png)

我们都知道，.代表目录本身，..代表父目录。从图中可知，1267是2549的父目录，因为2549的.指向本身，而1267的..指向父目录。所以，任何一个字目录（不包含其他目录的目录）的链接计数总是为2。

而父目录的链接计数则是随着子目录的增加而增加。（本身已有.和..两个，加入再建立子目录testdir，则testdir的..则指向父目录）

---

系列：
上一篇：{% post_link  %}
下一篇：{% post_link  %}
